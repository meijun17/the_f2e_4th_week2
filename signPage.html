<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        http-equiv="X-UA-Compatible"
        content="IE=edge"
    >
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <link
        rel="stylesheet"
        href="./css/main.css"
    >
    <title>小綠簽</title>
</head>

<body>
    <div class="bg-color-gray">
        <div class="loading bg-color-gray">
            <div
                id='lottie'
                class="lottie"
            ></div>
            <p>上傳中...</p>
        </div>


        <div class="container h-100">
            <div class="header">
                <a
                    class="logo"
                    href="/"
                >
                    <h1><img
                            src="./images/logo.png"
                            alt="logo"
                        /></h1>
                </a>
            </div>
            <div class="sign__content">
                <div class="tabs">
                    <button
                        type="button"
                        class="tab active"
                        id="hand-writing-tab"
                    >手寫簽名</button>
                    <button
                        type="button"
                        class="tab"
                        id="import-sign-tab"
                    >匯入簽名檔</button>
                </div>
                <!-- 手寫簽名 -->
                <div class="sign-area">
                    <div class="hand-writing-box">
                        <ul class="sign__colors">
                            <li class="color color-black active"></li>
                            <li class="color color-blue"></li>
                            <li class="color color-red"></li>
                        </ul>
                        <canvas
                            id="canvas"
                            class="canvas"
                            width="590"
                            height="224"
                        ></canvas>
                    </div>
                </div>
                <div class="btns">
                    <button
                        type="button"
                        id="clear-btn"
                        class="btn-primary-outline"
                    >清除</button>
                    <button
                        type="button"
                        id="create-btn"
                        class="btn-primary"
                    >建立簽名</button>
                </div>
            </div>
        </div>

        <img
            class="plant plant_left"
            src="./images/plant_left.png"
            alt="plant"
        />
        <img
            class="plant plant_right"
            src="./images/plant_right.png"
            alt="plant"
        />
        <img
            class="plant plant_grass"
            src="./images/grass.png"
            alt="plant"
        />
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/fabric@latest/dist/fabric.js"></script>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
    <script src="./js/animation.js"></script>

    <script>

        $(".tab").on('click', () => {
            $(".tab").toggleClass('active');
        });



        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://mozilla.github.io/pdf.js/build/pdf.worker.js";

        const canvas = document.querySelector("#canvas");
        const ctx = canvas.getContext("2d");
        const clearBtn = document.querySelector("#clear-btn");
        const createBtn = document.querySelector("#create-btn");

        // 確認滑鼠 / 手指是否按下
        let isPainting = false;

        // 下2行設定線條的相關數值
        ctx.lineWidth = 4;
        ctx.lineCap = "round";

        // 取得滑鼠 / 手指在畫布上的位置
        function getPaintPosition(e) {
            const canvasSize = canvas.getBoundingClientRect();
            if (e.type === "mousemove") {
                return {
                    x: e.clientX - canvasSize.left,
                    y: e.clientY - canvasSize.top,
                };
            } else {
                return {
                    x: e.touches[0].clientX - canvasSize.left,
                    y: e.touches[0].clientY - canvasSize.top,
                };
            }
        }

        // 開始繪圖時，將狀態開啟
        function startPosition(e) {
            e.preventDefault();
            isPainting = true;
        }

        // 結束繪圖時，將狀態關閉，並產生新路徑
        function finishedPosition() {
            isPainting = false;
            ctx.beginPath();
        }

        // 繪圖過程
        function draw(e) {
            e.preventDefault();
            if (!isPainting) return;

            // 取得滑鼠 / 手指位置
            const paintPosition = getPaintPosition(e);

            // 移動到滑鼠位置並產生圖案
            ctx.lineTo(paintPosition.x, paintPosition.y);
            ctx.stroke();
        }

        // 重新設定畫布
        function reset() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // 儲存圖片
        function createImage() {
            const newImg = canvas.toDataURL("image/png");
            localStorage.setItem("img", newImg);
            window.location.href = "signPDF.html";
        }

        // event listener 電腦板
        canvas.addEventListener("mousedown", startPosition);
        canvas.addEventListener("mouseup", finishedPosition);
        canvas.addEventListener("mouseleave", finishedPosition);
        canvas.addEventListener("mousemove", draw);

        // event listener 手機板
        canvas.addEventListener("touchstart", startPosition);
        canvas.addEventListener("touchend", finishedPosition);
        canvas.addEventListener("touchcancel", finishedPosition);
        canvas.addEventListener("touchmove", draw);

        // 重設按鈕
        clearBtn.addEventListener("click", reset);
        createBtn.addEventListener("click", createImage);


        // 選擇畫筆顏色
        $(".color-blue,.color-red,.color-black").click(function () {
            $(this).parent().find('.color').removeClass('active');
            $(this).addClass('active');
            let chooseColor = $(this)[0].classList.value;
            console.log($(this))
            if (chooseColor.includes('blue')) {
                ctx.fillStyle = "#0014C7";
                ctx.strokeStyle = "#0014C7";
            } else if (chooseColor.includes('red')) {
                ctx.fillStyle = "#ca0000";
                ctx.strokeStyle = "#ca0000";
            } else {
                ctx.fillStyle = "#000000";
                ctx.strokeStyle = "#000000";
            }

        })
    </script>
</body>

</html>